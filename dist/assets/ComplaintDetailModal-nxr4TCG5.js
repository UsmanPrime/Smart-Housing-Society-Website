import{j as e}from"./index-BR_n0HI9.js";import{r as i}from"./react-core-Ljpx9oFu.js";import{u as L}from"./useAuth-4QJvpUN4.js";import{u as U}from"./useComplaints-BOdCs5Ff.js";import{a as V}from"./api-B_kgTFai.js";const q="/api",K=()=>localStorage.getItem("token"),y=async(c,s={})=>{const o=K(),r={"Content-Type":"application/json",...o&&{Authorization:`Bearer ${o}`},...s.headers},m=await fetch(`${q}${c}`,{...s,headers:r}),p=await m.json();if(!m.ok)throw new Error(p.message||"API request failed");return p};function Y(){const[c,s]=i.useState(!1),[o,r]=i.useState(null),m=i.useCallback(async d=>{s(!0),r(null);try{const l=await y("/complaints",{method:"POST",body:JSON.stringify(d)});return s(!1),{success:!0,data:l.data}}catch(l){return r(l.message),s(!1),{success:!1,error:l.message}}},[]),p=i.useCallback(async(d,l)=>{s(!0),r(null);try{const n=await y(`/complaints/${d}`,{method:"PUT",body:JSON.stringify(l)});return s(!1),{success:!0,data:n.data}}catch(n){return r(n.message),s(!1),{success:!1,error:n.message}}},[]),v=i.useCallback(async(d,l)=>{s(!0),r(null);try{const n=await y(`/complaints/${d}/comments`,{method:"POST",body:JSON.stringify({text:l})});return s(!1),{success:!0,data:n.data}}catch(n){return r(n.message),s(!1),{success:!1,error:n.message}}},[]),b=i.useCallback(async(d,l)=>{s(!0),r(null);try{const n=await y(`/complaints/${d}`,{method:"PUT",body:JSON.stringify({status:l})});return s(!1),{success:!0,data:n.data}}catch(n){return r(n.message),s(!1),{success:!1,error:n.message}}},[]),u=i.useCallback(async(d,l)=>{s(!0),r(null);try{const n=await y(`/complaints/${d}/assign`,{method:"PUT",body:JSON.stringify({vendorId:l})});return s(!1),{success:!0,data:n.data}}catch(n){return r(n.message),s(!1),{success:!1,error:n.message}}},[]),t=i.useCallback(async d=>{s(!0),r(null);try{const l=await y(`/complaints/${d}`,{method:"DELETE"});return s(!1),{success:!0,data:l}}catch(l){return r(l.message),s(!1),{success:!1,error:l.message}}},[]);return{addComplaint:m,updateComplaint:p,addComment:v,updateStatus:b,assignVendor:u,deleteComplaint:t,loading:c,error:o}}function G({status:c}){const s={open:"bg-emerald-600",accepted:"bg-cyan-600",pending:"bg-amber-600","in-progress":"bg-blue-600",in_progress:"bg-blue-600",completed:"bg-purple-600",resolved:"bg-green-600",rejected:"bg-rose-600",closed:"bg-slate-600"},o=(c||"open").replace(/_/g," ").replace(/-/g," ");return e.jsx("span",{className:`inline-block px-2 py-1 text-xs rounded text-white ${s[c]||"bg-gray-600"}`,children:o})}function H({priority:c}){const s={low:"bg-teal-600",medium:"bg-indigo-600",high:"bg-orange-600",critical:"bg-red-600"},o=(c||"medium").toLowerCase();return e.jsx("span",{className:`inline-block px-2 py-1 text-xs rounded text-white ${s[o]||"bg-indigo-600"}`,children:o})}function Q({complaintId:c,category:s,currentVendor:o,onAssign:r}){const[m,p]=i.useState([]),[v,b]=i.useState(!0),[u,t]=i.useState(o||""),{user:d}=L();i.useEffect(()=>{(async()=>{try{b(!0);const g=(d==null?void 0:d.token)||localStorage.getItem("token")||void 0,f=await V.get(`/api/vendors?specialization=${encodeURIComponent(s)}`,{token:g});p((f==null?void 0:f.data)||[])}catch(g){console.error("Failed to fetch vendors:",g)}finally{b(!1)}})()},[s]),i.useEffect(()=>{t(o||"")},[o]);const l=n=>{const g=n.target.value;t(g),r&&r(g||null)};return v?e.jsx("select",{disabled:!0,className:"bg-gray-100 text-gray-600 text-sm rounded px-3 py-2 border border-gray-300",children:e.jsx("option",{children:"Loading vendors..."})}):e.jsxs("select",{value:u,onChange:l,className:"bg-white text-[#07164a] text-sm rounded px-3 py-2 border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-[#07164a] transition-colors","aria-label":"Assign vendor",children:[e.jsx("option",{value:"",children:"-- Select Vendor --"}),m.map(n=>e.jsxs("option",{value:n._id,children:[n.name," ",n.isAvailable===!1?"(Unavailable)":""]},n._id)),m.length===0&&e.jsxs("option",{disabled:!0,children:["No vendors available for ",s]})]})}const I=c=>{if(!c)return"";const s=Math.floor((Date.now()-new Date(c).getTime())/1e3);if(s<60)return`${s}s ago`;const o=Math.floor(s/60);if(o<60)return`${o}m ago`;const r=Math.floor(o/60);return r<24?`${r}h ago`:`${Math.floor(r/24)}d ago`};function se({complaint:c,onClose:s,onUpdate:o}){var _,E,R,P;const{user:r}=L(),{fetchComplaintById:m}=U(),{updateStatus:p,addComment:v,assignVendor:b,loading:u}=Y(),[t,d]=i.useState(c),[l,n]=i.useState(""),[g,f]=i.useState(!1),[j,N]=i.useState(0),[C,k]=i.useState(""),[S,$]=i.useState(!1),D=i.useRef(null),M=(r==null?void 0:r.role)==="admin",T=(r==null?void 0:r.role)==="vendor",O=(r==null?void 0:r.role)==="resident",B=T&&((_=t==null?void 0:t.assignedTo)==null?void 0:_._id)===(r==null?void 0:r.id),z=O&&(t==null?void 0:t.assignedTo)&&["completed","resolved","closed"].includes(t.status);i.useEffect(()=>{c!=null&&c._id&&(f(!0),m(c._id).then(a=>{a&&d(a),f(!1)}))},[c,m]),i.useEffect(()=>{const a=document.body.style.overflow;document.body.style.overflow="hidden";const x=h=>{h.key==="Escape"&&s()};return document.addEventListener("keydown",x),()=>{document.body.style.overflow=a,document.removeEventListener("keydown",x)}},[s]);const A=async()=>{if(!l.trim())return;if((await v(t._id,l.trim())).success){n("");const x=await m(t._id);x&&(d(x),o&&o())}},w=async a=>{if((await p(t._id,a)).success){const h=await m(t._id);h&&(d(h),o&&o())}},J=async a=>{if((await b(t._id,a)).success){const h=await m(t._id);h&&(d(h),o&&o())}},F=a=>{a.target===a.currentTarget&&s()};return t?e.jsx("div",{className:"fixed inset-0 z-[60] bg-black/60 flex items-center justify-center p-4",onMouseDown:F,children:e.jsxs("div",{ref:D,className:"bg-white rounded-xl w-full max-w-3xl overflow-hidden outline-none max-h-[90vh] flex flex-col",role:"dialog","aria-modal":"true","aria-labelledby":"complaint-dialog-title",children:[e.jsxs("div",{className:"bg-[#07164a] text-white px-5 py-3 flex items-center justify-between flex-shrink-0",children:[e.jsx("div",{id:"complaint-dialog-title",className:"font-semibold",children:"Complaint Details"}),e.jsx("button",{onClick:s,"aria-label":"Close",className:"hover:opacity-80 text-xl",children:"✕"})]}),e.jsxs("div",{className:"p-5 space-y-5 overflow-y-auto",children:[g&&e.jsx("div",{className:"text-center py-8 text-gray-600",children:"Loading details..."}),!g&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-xl font-semibold text-[#06164a]",children:t.title}),e.jsxs("div",{className:"text-sm text-gray-600 mt-1",children:["Category: ",e.jsx("span",{className:"font-medium capitalize",children:t.category}),t.location&&` • Location: ${t.location}`]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Created ",I(t.createdAt)," by ",((E=t.submittedBy)==null?void 0:E.name)||"Unknown"]})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap items-start",children:[e.jsx(G,{status:t.status}),e.jsx(H,{priority:t.priority})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm font-semibold text-gray-700 mb-2",children:"Description"}),e.jsx("p",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:t.description})]}),t.assignedTo&&e.jsx("div",{className:"bg-purple-50 rounded-lg p-3 border border-purple-200",children:e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-semibold",children:"Assigned to:"})," ",t.assignedTo.name,t.assignedTo.email&&` (${t.assignedTo.email})`]})}),M&&e.jsxs("div",{className:"border-t pt-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Update Status"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:["open","in-progress","resolved","closed"].map(a=>e.jsx("button",{onClick:()=>w(a),disabled:u,className:`text-xs px-3 py-1.5 rounded border transition-colors ${t.status===a?"bg-[#07164a] text-white border-[#07164a]":"bg-white text-[#07164a] border-gray-300 hover:bg-slate-100"} disabled:opacity-50`,children:a.replace(/-/g," ").toUpperCase()},a))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Assign Vendor"}),e.jsx(Q,{complaintId:t._id,category:t.category,currentVendor:(R=t.assignedTo)==null?void 0:R._id,onAssign:J})]})]}),T&&B&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Update Status"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>w("in-progress"),disabled:u||t.status==="in-progress",className:"text-xs px-3 py-1.5 rounded bg-yellow-600 text-white hover:bg-yellow-700 disabled:opacity-50",children:"Mark In Progress"}),e.jsx("button",{onClick:()=>w("completed"),disabled:u||t.status==="completed",className:"text-xs px-3 py-1.5 rounded bg-green-600 text-white hover:bg-green-700 disabled:opacity-50",children:"Mark Completed"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Note: Admin will review and mark as resolved"})]}),z&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("div",{className:"text-sm font-semibold mb-2",children:"Rate Vendor Service"}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[[1,2,3,4,5].map(a=>e.jsx("button",{type:"button",onClick:()=>N(a),className:`w-6 h-6 ${a<=j?"text-yellow-400":"text-gray-300"}`,"aria-label":`Rate ${a} star`,children:e.jsx("svg",{className:"w-6 h-6",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"})})},a)),e.jsxs("span",{className:"text-xs text-gray-600",children:[j," / 5"]})]}),e.jsx("textarea",{value:C,onChange:a=>k(a.target.value),rows:2,placeholder:"Optional comment",className:"w-full border rounded px-3 py-2 text-sm mb-2"}),e.jsx("button",{disabled:S||j===0,onClick:async()=>{if(j!==0)try{$(!0);const a=localStorage.getItem("token");await V.post(`/api/vendors/${t.assignedTo._id}/rate`,{complaintId:t._id,stars:j,comment:C.trim()||void 0},{token:a}),k(""),N(0),alert("Rating submitted successfully")}catch(a){alert((a==null?void 0:a.message)||"Failed to submit rating")}finally{$(!1)}},className:"bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded text-sm disabled:opacity-40",children:S?"Submitting...":"Submit Rating"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"You can rate once the task is completed / resolved."})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"text-sm font-semibold mb-3",children:["Comments (",((P=t.comments)==null?void 0:P.length)||0,")"]}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto mb-3",children:t.comments&&t.comments.length>0?t.comments.map((a,x)=>e.jsxs("div",{className:"bg-slate-50 rounded-lg px-4 py-3 text-sm",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1",children:[e.jsx("div",{className:"font-medium text-[#07164a]",children:a.authorName}),e.jsx("div",{className:"text-xs text-gray-500",children:I(a.createdAt)})]}),e.jsx("div",{className:"text-gray-700",children:a.text})]},a._id||x)):e.jsx("div",{className:"text-sm text-gray-500 text-center py-4",children:"No comments yet"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{value:l,onChange:a=>n(a.target.value),onKeyPress:a=>a.key==="Enter"&&A(),placeholder:"Add a comment...",className:"flex-1 bg-gray-100 border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#07164a]","aria-label":"Comment"}),e.jsx("button",{onClick:A,disabled:!l.trim()||u,className:"bg-[#07164a] text-white px-4 py-2 rounded text-sm hover:bg-[#0a1f6b] disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:u?"Posting...":"Post"})]})]})]})]}),e.jsx("div",{className:"flex justify-end gap-2 p-4 border-t bg-gray-50 flex-shrink-0",children:e.jsx("button",{onClick:s,className:"px-4 py-2 text-sm rounded border border-gray-300 hover:bg-gray-100 transition-colors",children:"Close"})})]})}):null}export{se as C,H as P,G as S,Y as u};
