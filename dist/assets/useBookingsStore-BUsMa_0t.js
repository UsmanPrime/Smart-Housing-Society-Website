import{r as l}from"./react-core-Ljpx9oFu.js";const E="http://localhost:5000/api";async function g(o,s={}){const k=localStorage.getItem("token"),i={"Content-Type":"application/json",...k&&{Authorization:`Bearer ${k}`}};try{const f=await fetch(E+o,{headers:i,credentials:"include",...s,body:s.body?JSON.stringify(s.body):void 0});if(!f.ok){const r=await f.text();let h=r||f.statusText;try{h=JSON.parse(r).message||h}catch{}throw new Error(h)}return f.status===204?null:f.json()}catch(f){throw console.error("API call failed:",E+o,f),f}}function v(o={}){const s={};for(const[k,i]of Object.entries(o))i==null||i===""||i==="undefined"||i==="null"||(s[k]=i);return s}const m={listFacilities:(o={})=>{const s=new URLSearchParams(o).toString();return g("/facilities"+(s?`?${s}`:""))},getFacility:o=>g(`/facilities/${o}`),createFacility:o=>g("/facilities",{method:"POST",body:o}),updateFacility:(o,s)=>g(`/facilities/${o}`,{method:"PUT",body:s}),deleteFacility:(o,s=!1)=>g(`/facilities/${o}${s?"?softDelete=true":""}`,{method:"DELETE"}),listBookings:(o={})=>{const s=new URLSearchParams(v(o)).toString();return g("/bookings"+(s?`?${s}`:""))},getBooking:o=>g(`/bookings/${o}`),createBooking:o=>g("/bookings",{method:"POST",body:o}),updateBooking:(o,s)=>g(`/bookings/${o}`,{method:"PUT",body:s}),deleteBooking:o=>g(`/bookings/${o}`,{method:"DELETE"}),approveBooking:o=>g(`/bookings/${o}/approve`,{method:"PUT"}),rejectBooking:(o,s)=>g(`/bookings/${o}/reject`,{method:"PUT",body:{rejectionReason:s}}),getCalendarData:(o,s,k)=>{const i=new URLSearchParams({startDate:s,endDate:k}).toString();return g(`/bookings/calendar/${o}?${i}`)},checkConflicts:(o,s,k,i=null)=>{const f=new URLSearchParams({facilityId:o,startTime:s,endTime:k,...i&&{excludeBookingId:i}}).toString();return g(`/bookings/conflicts/check?${f}`)}};function L(){const[o,s]=l.useState([]),[k,i]=l.useState([]),[f,r]=l.useState(!1),[h,n]=l.useState(null),y=l.useCallback(async(a=0)=>{try{r(!0),n(null),console.log("Fetching facilities from API... (attempt",a+1,")");const e=await m.listFacilities();console.log("Facilities loaded:",(e==null?void 0:e.length)||0);const t=(e||[]).map(u=>({...u,id:u._id||u.id}));s(t),r(!1)}catch(e){if(console.error("Error fetching facilities:",e),a===0&&e.message.includes("fetch")){console.log("Retrying facilities fetch..."),setTimeout(()=>y(1),1e3);return}n("Failed to load facilities: "+e.message),s([]),r(!1)}},[]);l.useEffect(()=>{y()},[y]);const d=l.useCallback(async(a={})=>{try{if(r(!0),n(null),!localStorage.getItem("token"))return console.warn("No auth token found - user may not be logged in"),i([]),r(!1),{bookings:[],total:0};console.log("Fetching bookings with filters:",a);const t=await m.listBookings(a);console.log("Bookings API response:",t);const u=(t.bookings||[]).map(c=>{var b,p,w,B;return{...c,id:c._id||c.id,start:c.startTime||c.start,end:c.endTime||c.end,facilityId:((b=c.facilityId)==null?void 0:b._id)||c.facilityId,facilityName:(p=c.facilityId)==null?void 0:p.name,userId:((w=c.userId)==null?void 0:w._id)||c.userId,userName:(B=c.userId)==null?void 0:B.name}});return console.log("Normalized bookings:",u.length,"bookings"),i(u),r(!1),{...t,bookings:u}}catch(e){return console.error("Error fetching bookings:",e),console.error("Error details:",e.message),n("Failed to load bookings: "+(e.message||"Unknown error")),i([]),r(!1),{bookings:[],total:0}}},[]),S=l.useCallback(async a=>{try{r(!0),n(null);const e=await m.createBooking(a);return await d(),{ok:!0,booking:e.booking,message:e.message}}catch(e){console.error("Error creating booking:",e);try{const t=JSON.parse(e.message);if(t.conflicts)return{ok:!1,conflicts:t.conflicts,message:t.message};if(t.errors)return{ok:!1,error:t.errors.join(", "),message:t.message}}catch{}return n(e.message),{ok:!1,error:e.message}}finally{r(!1)}},[d]),C=l.useCallback(async(a,e)=>{try{r(!0),n(null);const t=await m.updateBooking(a,e);return await d(),{ok:!0,booking:t.booking,message:t.message}}catch(t){return console.error("Error updating booking:",t),n(t.message),{ok:!1,error:t.message}}finally{r(!1)}},[d]),F=l.useCallback(async a=>{try{return r(!0),n(null),await m.deleteBooking(a),await d(),{ok:!0,message:"Booking cancelled successfully"}}catch(e){return console.error("Error deleting booking:",e),n(e.message),{ok:!1,error:e.message}}finally{r(!1)}},[d]),$=l.useCallback(async a=>{try{r(!0),n(null);const e=await m.approveBooking(a);return await d(),{ok:!0,booking:e.booking,message:e.message}}catch(e){return console.error("Error approving booking:",e),n(e.message),{ok:!1,error:e.message}}finally{r(!1)}},[d]),P=l.useCallback(async(a,e)=>{try{r(!0),n(null);const t=await m.rejectBooking(a,e);return await d(),{ok:!0,booking:t.booking,message:t.message}}catch(t){return console.error("Error rejecting booking:",t),n(t.message),{ok:!1,error:t.message}}finally{r(!1)}},[d]),I=l.useCallback(async(a,e,t)=>{try{return r(!0),n(null),await m.getCalendarData(a,e,t)}catch(u){return console.error("Error fetching calendar data:",u),n(u.message),[]}finally{r(!1)}},[]),T=l.useCallback(async(a,e,t,u=null)=>{try{return await m.checkConflicts(a,e,t,u)}catch(c){return console.error("Error checking conflicts:",c),{hasConflicts:!1,conflicts:[]}}},[]),j=l.useCallback(()=>o,[o]),U=l.useCallback(a=>k.filter(e=>{var t;return((t=e.userId)==null?void 0:t._id)===a||e.userId===a}),[k]);return{facilities:o,bookings:k,loading:f,error:h,fetchFacilities:y,fetchBookings:d,refresh:d,listFacilities:j,listMyBookings:U,createBooking:S,updateBooking:C,deleteBooking:F,approveBooking:$,rejectBooking:P,getCalendarData:I,checkConflicts:T}}export{L as u};
